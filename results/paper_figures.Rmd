---
title: "Left truncation simulations"
author: "Arjun Sondhi"
output:   
  html_document:
    theme: yeti
    highlight: tango
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

__Date generated:__ `r format(Sys.time(), '%B %e, %Y')`   

__Generated by:__ `r Sys.info()[8]`

***    
## Setting 1: Two real world treatment arms
***

```{r load allrw}
load("SimResults_allrw.RData")
```

In this setting, we are interested in comparing the effectiveness of two treatments, with real-world data observed in both arms. 
The estimand, or parameter of interest, is the hazard ratio comparing the treatment arms, as estimated by a Cox model fit to the non-truncated dataset (which is not observed in practice).
We evaluate Cox hazard ratio estimates fit to the observed left truncated dataset, comparing the risk set adjusted Cox model estimator to the naive one which does not account for delayed entry.

We fix the following parameters:

* Baseline hazard at 1/12 (equivalent to a mean survival time of 12 months for control arm patients who entered at or before index)
* Probability of pre-index entry at 0.2 (that is, 20% of all patients had no delayed entry)
* Observed sample size in the truncated dataset at 300

We vary the following parameters:

* Probability of a subject being left truncated
* Dependency of entry time with survival (captured by a hazard ratio comparing patients who entered one month apart)

To evaluate the performance of the estimators, we first examine the relative bias of the hazard ratio estimate compared to the true hazard ratio.

```{r}
results %>%
  filter(n * (1 - p_lt) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("rel_bias", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = rel_bias, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_linerange(aes(ymin=rel_bias - 1.96*se_rel_bias, ymax=rel_bias + 1.96*se_rel_bias)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed",
             scales = "free_x") +
  ylab("HR relative bias") +
  xlab("probability of left truncation") +
  geom_hline(yintercept = 1) +
  theme_bw() +
  theme(text = element_text(size = 20)) + 
  ylim(0, 1.05)
```

We next examine the coverage of the HR 95% confidence intervals with respect to the true HR.

```{r}
results %>%
  filter(n * (1 - p_lt) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("coverage", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = coverage, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.95) +
  geom_linerange(aes(ymin=coverage - 1.96*se_coverage, ymax=coverage + 1.96*se_coverage)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed",
             scales = "free_x") +
  ylab("HR CI coverage") +
  xlab("probability of left truncation") +
  ylim(0,1) +
  theme_bw() +
  theme(text = element_text(size = 20))
```


***    
## Setting 2: Trial treatment arm and real world control arm
***

```{r load rwca}
load("SimResults_rwca.RData")
```

In this setting, we are again comparing the effectiveness of two treatments, but with trial data in a treatment arm and a real-world control arm. 
Therefore, only the control arm is subject to delayed entry and left truncation.
The estimand, or parameter of interest, is the hazard ratio comparing the treatment arms, as estimated by a Cox model fit to the non-truncated dataset (which is not observed in practice).
We evaluate Cox hazard ratio estimates fit to the observed left truncated dataset, comparing the risk set adjusted Cox model estimator to the naive one which does not account for delayed entry.

We fix the following parameters:

* Baseline hazard at 1/12 (equivalent to a mean survival time of 12 months for control arm patients who entered at or before index)
* Probability of pre-index entry at 0.2 (that is, 20% of rwCA patients had no delayed entry)
* 1:1 treatment:control ratio
* Observed sample size in the truncated dataset at 300

We vary the following parameters:

* Probability of a subject being left truncated
* Dependency of entry time with survival (captured by a hazard ratio comparing patients who entered one month apart)

To evaluate the performance of the estimators, we first examine the relative bias of the hazard ratio estimate compared to the true hazard ratio.

```{r}
results %>%
  filter(n / (p_trt + (1 - p_trt)/(1 - p_lt)) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("rel_bias", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = rel_bias, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_linerange(aes(ymin=rel_bias - 1.96*se_rel_bias, ymax=rel_bias + 1.96*se_rel_bias)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed",
             scales = "free_x") +
  ylab("HR relative bias") +
  xlab("probability of left truncation") +
  geom_hline(yintercept = 1) +
  theme_bw() +
  theme(text = element_text(size = 20))
```

We next examine the coverage of the HR 95% confidence intervals with respect to the true HR.

```{r}
results %>%
  filter(n / (p_trt + (1 - p_trt)/(1 - p_lt)) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("coverage", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = coverage, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.95) +
  geom_linerange(aes(ymin=coverage - 1.96*se_coverage, ymax=coverage + 1.96*se_coverage)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed",
             scales = "free_x") +
  ylab("HR CI coverage") +
  xlab("probability of left truncation") +
  ylim(0,1) +
  theme_bw() +
  theme(text = element_text(size = 20))
```


***    
## Setting 3: Single real world treatment arm
***

```{r load singlerw}
load("SimResults_singlerw.RData")
```

In this setting, we are estimating OS in a single real-world treatment arm that is subject to delayed entry and left truncation.
We consider both median survival and restricted mean survival time as parameters of interest.
As before, the "true" value is taken as that estimated on the non-truncated dataset (which is not observed in practice).

We compare the following estimators of median OS:

* The naive Kaplan-Meier estimator which does not account for delayed entry
* The risk set adjusted Kaplan-Meier estimator that accounts for independent left truncation

We fix the following parameters:

* Baseline hazard at 1/12 (equivalent to a mean survival time of 12 months for patients who entered at or before index date)
* Probability of pre-index entry at 0.2 (that is, 20% of patients had no delayed entry)
* Observed sample size in the truncated dataset at 300

We vary the following parameters:

* Probability of a subject being left truncated
* Dependency of entry time with survival (captured by a hazard ratio comparing patients who entered one month apart)

To evaluate the performance of the estimators, we first examine the relative bias of the median OS estimate compared to the true median.

```{r}
results %>%
  filter(n * (1 - p_lt) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("median_rel_bias", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  filter(model != "mackenzie") %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = median_rel_bias, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_linerange(aes(ymin=median_rel_bias - 1.96*se_median_rel_bias, ymax=median_rel_bias + 1.96*se_median_rel_bias)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed") +
  ylab("Median OS relative bias") +
  xlab("probability of left truncation") +
  geom_hline(yintercept = 1) +
  theme_bw() +
  theme(text = element_text(size = 20))
```

We now examine the coverage of 95% confidence intervals for the median. 

```{r}
results %>%
  filter(n * (1 - p_lt) < 500) %>%
  filter(baseline_hazard == 1/12) %>%
  filter(p_preindex == 0.2) %>%
  filter(hr_dep %in% c(1, 1.01, 1.05, 1.1)) %>%
  filter(grepl("median_coverage", metric)) %>%
  filter(!(grepl("baseline", model))) %>%
  mutate(model = replace(model, model == "risk_set_adjustment", "risk set adjustment")) %>%
  mutate(hr_dep = recode(hr_dep, 
                         `1` = "exp(beta[E]) == 1", 
                         `1.01` = "exp(beta[E]) == 1.01",
                         `1.05` = "exp(beta[E]) == 1.05",
                         `1.1` = "exp(beta[E]) == 1.1")) %>%
  pivot_wider(names_from = metric,
              values_from = value) %>%
  ggplot(aes(x = p_lt, y = median_coverage, col = model)) +
  geom_point(size = 2.5) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.95) +
  geom_linerange(aes(ymin=median_coverage - 1.96*se_median_coverage, ymax=median_coverage + 1.96*se_median_coverage)) +
  facet_wrap(vars(hr_dep), 
             label = "label_parsed",
             scales = "free_x") +
  ylab("Median OS CI coverage") +
  xlab("probability of left truncation") +
  ylim(0,1) +
  theme_bw() +
  theme(text = element_text(size = 20))
```

***
## R Code Session information
***

```{r}
sessionInfo()
```

